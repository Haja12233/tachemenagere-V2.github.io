<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrice 4x4 - Gestion de TÃ¢che</title>
    <link rel="stylesheet" href="style.css">
    <style>
    :root {
    --primary-color: #0056b3;
    --primary-hover-color: #00448a;
    --success-color: #28a745;
    --success-hover-color: #218838;
    --text-color: #333;
    --secondary-text-color: #6c757d;
    --border-color: #e0e0e0;
    --bg-color: #f8f9fa;
    --card-bg-color: #ffffff;
    --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 10vh;
        margin: 0;
        padding: 20px;
    }

    .container {
        width: 100%;
        max-width: 700px;
        background: var(--card-bg-color);
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 25px;
        font-size: 1.8rem;
        font-weight: 600;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    .cell {
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        aspect-ratio: 1/1;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: 15px;
        color: var(--text-color);
        background-color: var(--card-bg-color);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        padding: 10px;
        text-align: center;
        word-break: break-word;
    }
    
    .cell#c2 {
        display: block;
        padding: 8px;
    }

    .cell:hover:not(.empty-cell):not(.default-user-active) {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-light);
    }

    .empty-cell {
        background-color: var(--bg-color);
        border: 1px dashed var(--border-color);
        cursor: default;
    }

    .cell-content {
        font-weight: 500;
        color: var(--text-color);
    }

    .cell-content.placeholder {
        font-style: italic;
        color: var(--secondary-text-color);
    }

    .cell button {
        width: 100%;
        height: 100%;
        border: none;
        background: var(--primary-color);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: bold;
        transition: background-color 0.2s;
        padding: 5px;
    }

    .cell button:hover {
        background: var(--primary-hover-color);
    }

    .cell .button-container {
        display: flex;
        gap: 8px;
        width: 100%;
        height: 100%;
        justify-content: center;
        align-items: center;
    }

    .cell .choice-button {
        flex-grow: 1;
        height: 80%;
        background: var(--bg-color);
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.2s;
    }

    .cell .choice-button:hover {
        background: var(--primary-color);
        color: white;
    }

    /* Styles pour la liste des lieux */
    .location-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
    }

    .location-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 0;
        width: 100%;
        flex-grow: 1;
        overflow-y: auto;
        margin-bottom: 6px;
    }
    

    .location-item {
        padding: 8px 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--card-bg-color);
        font-size: 14px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }

    .location-item:hover {
        background-color: #e9ecef;
    }

    .location-item.empty {
        font-style: italic;
        color: var(--secondary-text-color);
    }

    .list-add-button {
        display: block;
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--primary-color);
        color: white;
        font-weight: bold;
        font-size: 16px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s;
        position : relative;
        left: -11px;
        line-height: 1; /* Pour centrer le + */
    }
    
    .list-add-button:hover {
        background-color: var(--primary-hover-color);
    }

    .add-button {
        width: 100%;
        padding: 8px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 8px;
        font-size: 1.5rem;
        line-height: 1;
    }

    .add-button:hover {
        background-color: var(--primary-hover-color);
    }

    .dropdown-menu {
        display: none;
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        width: 100%;
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        z-index: 10;
        max-height: 200px;
        overflow-y: auto;
    }

    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
    .dropdown-item:last-child { border-bottom: none; }
    .dropdown-item:hover { background-color: var(--bg-color); }
    .dropdown-item-content { flex-grow: 1; }

    .add-item {
        font-size: 1.2rem;
        padding: 8px 15px;
        color: var(--primary-color);
        font-weight: bold;
        text-align: center;
    }

    .text-green {
        color: #28a745;
        font-weight: bold;
    }

    .text-red {
        color: #dc3545;
        font-weight: bold;
    }

    .default-user {
        opacity: 0.8;
        font-style: italic;
        font-weight: 500;
    }

    .default-user-active {
        cursor: default;
        background-color: #e9f0f6;
        border-color: var(--primary-color);
    }

    #refresh-button {
        margin-top: 25px;
        padding: 12px 25px;
        background-color: var(--success-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.2s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #refresh-button:hover {
        background-color: var(--success-hover-color);
        transform: translateY(-2px);
    }

    #notification-banner {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 25px;
        background-color: var(--success-color);
        color: white;
        font-weight: bold;
        font-size: 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease-in-out, visibility 0.5s;
        pointer-events: none;
        max-width: 90%;
        text-align: center;
    }

    #notification-banner.show {
        opacity: 1;
        visibility: visible;
    }

    /* Scrollbar Style */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #a0a0a0;
    }
    #c2.text-green {
    background-color: #d4edda !important;
    color: #155724 !important;
    }
    #c2.text-red {
        background-color: #f8d7da !important;
        color: #721c24 !important;
    }
    #c2 .cell-content {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    font-size: 1.6em;
    font-weight: bold;
    text-align: center;
    }

    @media (max-width: 768px) {
        .container {
            padding: 15px;
        }
        h1 {
            font-size: 1.5rem;
        }
        .grid {
            gap: 10px;
        }
        .cell {
            font-size: 13px;
            padding: 8px;
        }
        .cell button {
            font-size: 12px;
        }
        .choice-button {
            font-size: 14px !important;
        }
        .location-item, .dropdown-item {
            font-size: 13px;
            padding: 10px;
        }
        #refresh-button {
            padding: 10px 20px;
            font-size: 14px;
        }
    }
    </style>
</head>
<body>

<div id="notification-banner">TÃ¢che complÃ¨te ! ðŸŽ‰</div>

<div class="container">
    <h1>Gestion des TÃ¢ches</h1>
    <div class="grid">
        <div class="cell" id="a1" data-initial-text="Locale">
            <span class="cell-content placeholder">Locale</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell empty-cell" id="b1"></div>
        <div class="cell empty-cell" id="c1"></div>
        <div class="cell" id="d1" data-initial-text="Utilisateur">
            <span class="cell-content placeholder">Utilisateur</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell" id="a2" data-initial-text="DÃ©but TÃ¢che">
            <button>DÃ©but</button>
        </div>
        <div class="cell empty-cell" id="b2"></div>
        <div class="cell" id="c2" data-initial-text=""></div>
        <div class="cell empty-cell" id="d2"></div>
        <div class="cell" id="a3" data-initial-text="Fin TÃ¢che">
            <button>Fin</button>
        </div>
        <div class="cell empty-cell" id="b3"></div>
        <div class="cell" id="c3" data-initial-text="ContrÃ´le Xylophage">
            <span class="cell-content placeholder">ContrÃ´le Xylophage</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell empty-cell" id="d3"></div>
        <div class="cell" id="a4" data-initial-text="Note">
            <span class="cell-content placeholder">Note</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell" id="b4" data-initial-text="Note">
            <span class="cell-content placeholder">Note</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell" id="c4" data-initial-text="Note">
            <span class="cell-content placeholder">Note</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell" id="d4" data-initial-text="Note">
            <span class="cell-content placeholder">Note</span>
            <div class="dropdown-menu"></div>
        </div>
    </div>
    <button id="refresh-button">ðŸ”„ Actualiser toutes les cases</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    
    const initialUsers = ['Anniva', 'Tina'];
    let initialLocales = ['P1', 'P2', 'P3', 'P4', 'P5', 'P6', 'P7', 'P8', 'P9', 'P10'];
    let defaultUser = null, defaultUserExpiry = null;
    let defaultLocale = null, defaultLocaleExpiry = null;
    const requiredCells = ['a1', 'a2', 'a3', 'c2', 'c3', 'd1'];
    let clickTimeout = null;

    // L'URL de votre application web Google Apps Script.
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz7NrE1iwl4vthz2Sxx3DIOoRXrSkq8nolvjefXo-w-KdBaP948MGa19hRanVgR5EQK/exec';

    function saveResults() {
        const results = {};
        const cellsToSave = ['a1', 'a2', 'a3', 'a4', 'b4', 'c2', 'c3', 'c4', 'd1', 'd4'];
        cellsToSave.forEach(id => {
            const cell = document.getElementById(id);
            if (!cell) return;
            const contentSpan = cell.querySelector('.cell-content');
            const contentButton = cell.querySelector('button:not(.choice-button)');
            let currentValue = '', color = '';

            if (id === 'c2') {
                const locationList = cell.querySelector('.location-list');
                const contentSpanC2 = cell.querySelector('.cell-content');
                if (locationList) {
                    const locationsWithColor = Array.from(locationList.querySelectorAll('.location-item')).map(item => {
                        let c = 'none';
                        if(item.classList.contains('text-green')) c = 'green';
                        if(item.classList.contains('text-red')) c = 'red';
                        return { text: item.textContent.trim(), color: c };
                    });
                    currentValue = JSON.stringify(locationsWithColor);
                } else if (contentSpanC2) {
                    currentValue = contentSpanC2.textContent.trim();
                } else {
                    currentValue = '';
                }
            } else if (contentSpan) {
                currentValue = contentSpan.textContent.trim();
                if (cell.classList.contains('text-green')) color = 'green';
                else if (cell.classList.contains('text-red')) color = 'red';
            } else if (contentButton) {
                currentValue = contentButton.textContent.trim();
            }

            const initialText = cell.getAttribute('data-initial-text');
            if (currentValue && currentValue !== initialText) {
                results[id] = { value: currentValue, color: color };
            }
        });
        localStorage.setItem('taskResults', JSON.stringify(results));
    }

    function loadResults() {
        const savedResults = localStorage.getItem('taskResults');
        if (savedResults) {
            const results = JSON.parse(savedResults);
            for (const id in results) {
                const cell = document.getElementById(id);
                if (!cell) continue;
                
                if (id === 'c2') {
                    const value = results[id].value;
                    try {
                        const locationsWithColor = JSON.parse(value);
                        if (Array.isArray(locationsWithColor)) {
                            showC2LocationList();
                            const container = cell.querySelector('.location-list');
                            container.innerHTML = '';
                            locationsWithColor.forEach(loc => {
                                const locationItem = document.createElement('div');
                                locationItem.className = 'location-item';
                                locationItem.textContent = loc.text;
                                if (loc.color === 'green') {
                                    locationItem.classList.add('text-green');
                                    locationItem.dataset.colorState = '1';
                                } else if (loc.color === 'red') {
                                    locationItem.classList.add('text-red');
                                    locationItem.dataset.colorState = '2';
                                } else {
                                    locationItem.dataset.colorState = '0';
                                }
                                container.appendChild(locationItem);
                            });
                            updateC2BackgroundColor();
                        } else {
                            showC2Buttons();
                            const contentSpan = document.createElement('span');
                            contentSpan.className = 'cell-content';
                            contentSpan.textContent = value;
                            cell.innerHTML = '';
                            cell.appendChild(contentSpan);
                            // --> RÃ©appliquer la couleur sauvegardÃ©e
                            cell.classList.remove('text-green', 'text-red');
                            if (results[id].color === 'green') cell.classList.add('text-green');
                            else if (results[id].color === 'red') cell.classList.add('text-red');
                        }
                    } catch (e) {
                        showC2Buttons();
                        const contentSpan = document.createElement('span');
                        contentSpan.className = 'cell-content';
                        contentSpan.textContent = value;
                        cell.innerHTML = '';
                        cell.appendChild(contentSpan);
                    }
                } else {
                    const contentSpan = cell.querySelector('.cell-content');
                    const contentButton = cell.querySelector('button');
                    if (contentSpan) {
                        contentSpan.textContent = results[id].value;
                        contentSpan.classList.remove('placeholder');
                        if (results[id].color === 'green') cell.classList.add('text-green');
                        else if (results[id].color === 'red') cell.classList.add('text-red');
                    } else if (contentButton) {
                        contentButton.textContent = results[id].value;
                    }
                }
            }
        }
    }

    function showC2Buttons() {
        const c2Cell = document.getElementById('c2');
        c2Cell.innerHTML = `
            <div class="button-container">
                <button class="choice-button" data-value="R">R</button>
                <button class="choice-button" data-value="xR">xR</button>
            </div>`;
    }
    
    function showC2LocationList() {
        const c2Cell = document.getElementById('c2');
        c2Cell.innerHTML = `
            <div class="location-container">
                <div class="location-list"></div>
                <div class="list-add-button" id="add-locale-c2">+</div>
            </div>`;
    }

    function resetAll() {
        const cellsToReset = ['a1', 'a2', 'a3', 'a4', 'b4', 'c2', 'c3', 'c4', 'd1', 'd4'];
        cellsToReset.forEach(id => {
            const cell = document.getElementById(id);
            if (!cell) return;
            if (id === 'c2') {
                showC2Buttons();
            } else if (id === 'a2' || id === 'a3') {
                cell.innerHTML = `<button>${id === 'a2' ? 'DÃ©but' : 'Fin'}</button>`;
            } else {
                const initialText = cell.getAttribute('data-initial-text');
                const contentSpan = cell.querySelector('.cell-content');
                if (contentSpan) {
                    contentSpan.textContent = initialText;
                    contentSpan.classList.add('placeholder');
                    contentSpan.classList.remove('default-user');
                }
            }
            cell.classList.remove('text-green', 'text-red', 'default-user-active');
        });
        localStorage.removeItem('taskResults');
        defaultUser = null; defaultUserExpiry = null; defaultLocale = null; defaultLocaleExpiry = null;
        localStorage.removeItem('defaultUserD1'); localStorage.removeItem('defaultLocaleA1');
        updateA1MenuWithDefaults();
        updateD1MenuWithDefault();
    }
    
    // --- Fonctions utilitaires ---
    function createDropdownItem(text) { const i = document.createElement('div'); i.className = 'dropdown-item'; const s = document.createElement('span'); s.className = 'dropdown-item-content'; s.textContent = text; i.appendChild(s); return i; }
    function showNotification(message, isCompletion = false) { const n = document.getElementById('notification-banner'); n.textContent = message; n.classList.add('show'); setTimeout(() => { n.classList.remove('show'); if (isCompletion) resetAll(); }, 2000); }
    function manualRefresh() { resetAll(); showNotification('Toutes les cases ont Ã©tÃ© rÃ©initialisÃ©es ! ðŸ”„'); }
    function updateResults() { saveResults(); }
    function checkCompletion() { for (const id of requiredCells) { const cell = document.getElementById(id); if (!cell) return false; if (id === 'c2') { const contentSpan = cell.querySelector('.cell-content'); const locationList = cell.querySelector('.location-list'); if (!contentSpan && !locationList) return false; if (contentSpan && (contentSpan.textContent.trim() === 'R' || contentSpan.textContent.trim() === 'xR')) return true; if (locationList) { const locations = Array.from(locationList.querySelectorAll('.location-item')).map(item => item.textContent.trim()); if (locations.length > 0) return true; } } else { const initialText = cell.getAttribute('data-initial-text'); const contentSpan = cell.querySelector('.cell-content'); const contentButton = cell.querySelector('button'); let currentValue = contentSpan ? contentSpan.textContent.trim() : (contentButton ? contentButton.textContent.trim() : ''); if (!currentValue || currentValue === initialText) return false; } } showNotification('TÃ¢che complÃ¨te ! ðŸŽ‰', true); return true; }

    // Fonctions pour D1
    function saveDefaultUser() { if (defaultUser) localStorage.setItem('defaultUserD1', JSON.stringify({ user: defaultUser, expiry: defaultUserExpiry })); }
    function loadDefaultUser() { const d = localStorage.getItem('defaultUserD1'); if (d) { const u = JSON.parse(d); if (u.expiry > Date.now()) { defaultUser = u.user; defaultUserExpiry = u.expiry; const c = document.getElementById('d1'); c.querySelector('.cell-content').textContent = defaultUser; c.querySelector('.cell-content').classList.remove('placeholder'); c.querySelector('.cell-content').classList.add('default-user'); c.classList.add('default-user-active'); updateD1MenuWithDefault(); } else { localStorage.removeItem('defaultUserD1'); } } }
    function setDefaultUser(name) { defaultUser = name; defaultUserExpiry = Date.now() + 28800000; const c = document.getElementById('d1'); c.querySelector('.cell-content').textContent = defaultUser; c.querySelector('.cell-content').classList.remove('placeholder'); c.querySelector('.cell-content').classList.add('default-user'); c.classList.add('default-user-active'); saveDefaultUser(); updateD1MenuWithDefault(); showNotification(`Utilisateur "${defaultUser}" dÃ©fini par dÃ©faut pour 8h !`); }
    function updateD1MenuWithDefault() { const m = document.querySelector('#d1 .dropdown-menu'); m.innerHTML = ''; if (defaultUser) { const i = createDropdownItem(`â˜… ${defaultUser} (par dÃ©faut)`); i.classList.add('default-user-item'); m.appendChild(i); } initialUsers.forEach(u => { if (u !== defaultUser) m.appendChild(createDropdownItem(u)); }); const a = createDropdownItem('+'); a.classList.add('add-item'); m.appendChild(a); }

    // Fonctions pour A1 (nouvelles)
    function saveDefaultLocale() { if (defaultLocale) localStorage.setItem('defaultLocaleA1', JSON.stringify({ locale: defaultLocale, expiry: defaultLocaleExpiry })); }
    function loadDefaultLocale() { const d = localStorage.getItem('defaultLocaleA1'); if (d) { const l = JSON.parse(d); if (l.expiry > Date.now()) { defaultLocale = l.locale; defaultLocaleExpiry = l.expiry; const c = document.getElementById('a1'); c.querySelector('.cell-content').textContent = defaultLocale; c.querySelector('.cell-content').classList.remove('placeholder'); c.querySelector('.cell-content').classList.add('default-user'); c.classList.add('default-user-active'); updateA1MenuWithDefaults(); } else { localStorage.removeItem('defaultLocaleA1'); } } }
    function setDefaultLocale(name) { defaultLocale = name; defaultLocaleExpiry = Date.now() + 28800000; const c = document.getElementById('a1'); c.querySelector('.cell-content').textContent = defaultLocale; c.querySelector('.cell-content').classList.remove('placeholder'); c.querySelector('.cell-content').classList.add('default-user'); c.classList.add('default-user-active'); saveDefaultLocale(); updateA1MenuWithDefaults(); showNotification(`Locale "${defaultLocale}" dÃ©finie par dÃ©faut pour 8h !`); }
    function updateA1MenuWithDefaults() { const m = document.querySelector('#a1 .dropdown-menu'); m.innerHTML = ''; if (defaultLocale) { const i = createDropdownItem(`â˜… ${defaultLocale} (par dÃ©faut)`); i.classList.add('default-locale-item'); m.appendChild(i); } initialLocales.forEach(l => { if (l !== defaultLocale) m.appendChild(createDropdownItem(l)); });  }

    // --- Fonctions pour la C2 simplifiÃ©es ---
    function handleRChoice(cell) {
        cell.innerHTML = `<span class="cell-content">Chargement...</span>`;
        setTimeout(() => {
            showC2LocationList();
            const locale = document.querySelector('#a1 .cell-content').textContent.trim();
            const url = `${SCRIPT_URL}?locale=${encodeURIComponent(locale)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = cell.querySelector('.location-list');
                    container.innerHTML = '';
                    if (data.success && data.data.length > 0) {
                        data.data.forEach(location => {
                            const locationItem = document.createElement('div');
                            locationItem.className = 'location-item';
                            locationItem.textContent = location;
                            locationItem.dataset.colorState = '0';
                            container.appendChild(locationItem);
                        });
                    } else {
                        const emptyItem = document.createElement('div');
                        emptyItem.className = 'location-item empty';
                        emptyItem.textContent = 'Pas de "OUI" pour cette locale';
                        container.appendChild(emptyItem);
                    }
                })
                .catch(error => {
                    console.error('Erreur de connexion Ã  l\'API:', error);
                    const container = cell.querySelector('.location-list');
                    container.innerHTML = '';
                    const errorItem = document.createElement('div');
                    errorItem.className = 'location-item empty';
                    errorItem.textContent = 'Erreur rÃ©seau';
                    container.appendChild(errorItem);
                });
        }, 300); // DÃ©lai de 300ms
    }

    function handleXRChoice(cell, value) {
        cell.innerHTML = `<span class="cell-content">${value}</span>`;
        cell.style.backgroundColor = '';
        cell.classList.remove('text-green', 'text-red');
        cell.dataset.locked = "true"; // Bloque la case
        updateResults();
        checkCompletion();
    }

    function handleListAdd(cell) {
        const newLocation = prompt("Veuillez entrer le nom du nouvel endroit :");
        if (newLocation && newLocation.trim()) {
            let container = cell.querySelector('.location-list');
            if (!container) {
                showC2LocationList();
                container = cell.querySelector('.location-list');
            }
            const newLocationItem = document.createElement('div');
            newLocationItem.className = 'location-item';
            newLocationItem.textContent = newLocation.trim();
            newLocationItem.dataset.colorState = '0';
            container.appendChild(newLocationItem);
            updateResults();
        }
    }

    function handleLocationItemClick(locationItem) {
        let state = parseInt(locationItem.dataset.colorState || '0');
        state = (state + 1) % 3;
        locationItem.dataset.colorState = state;
        locationItem.classList.remove('text-green', 'text-red');
        if (state === 1) {
            locationItem.classList.add('text-green');
        } else if (state === 2) {
            locationItem.classList.add('text-red');
        }
    
        // Mise Ã  jour immÃ©diate, plus de timeout
        updateC2BackgroundColor();
        updateResults();
        checkCompletion();
    }
    
    function updateC2BackgroundColor() {
        const c2Cell = document.getElementById('c2');
        const locationItems = Array.from(c2Cell.querySelectorAll('.location-item'));
        
        c2Cell.classList.remove('text-green', 'text-red');
        
        if (locationItems.length > 0) {
            const hasRed = locationItems.some(item => item.classList.contains('text-red'));
            const hasGreen = locationItems.some(item => item.classList.contains('text-green'));
            
            if (hasRed) {
                c2Cell.classList.add('text-red');
            } else if (hasGreen) {
                c2Cell.classList.add('text-green');
            }
        }
    }

    // --- Configuration Initiale ---
    updateA1MenuWithDefaults();
    updateD1MenuWithDefault();
    const c3Menu = document.querySelector('#c3 .dropdown-menu');
    const xylophageItem = createDropdownItem('Xylophage');
    xylophageItem.dataset.colorState = '0';
    c3Menu.appendChild(xylophageItem);
    ['#a4', '#b4', '#c4', '#d4'].forEach(cellId => { const menu = document.querySelector(`${cellId} .dropdown-menu`); ['Vide', '1', '2', '3'].forEach(opt => menu.appendChild(createDropdownItem(opt))); });
    
    showC2Buttons();
    loadResults();
    loadDefaultUser();
    loadDefaultLocale();

    // --- Gestionnaire d'Ã‰vÃ©nements Principal ---
    const grid = document.querySelector('.grid');
    let activeMenu = null;
    
    document.addEventListener('click', function(event) {
        const c2Cell = document.getElementById('c2');
        const isClickInsideC2 = c2Cell.contains(event.target);
    
        if (!isClickInsideC2 && !c2Cell.dataset.locked) {
            const locationListExists = c2Cell.querySelector('.location-list');
            if (locationListExists) {
                const locationItems = Array.from(c2Cell.querySelectorAll('.location-item'));
                const hasRed = locationItems.some(item => item.classList.contains('text-red'));
                const hasGreen = locationItems.some(item => item.classList.contains('text-green'));
                c2Cell.innerHTML = `<span class="cell-content">R</span>`;
                c2Cell.classList.remove('text-green', 'text-red');
                if (hasRed) {
                    c2Cell.classList.add('text-red');
                } else if (hasGreen) {
                    c2Cell.classList.add('text-green');
                }
                c2Cell.dataset.locked = "true"; // On bloque la case
                updateResults();
                checkCompletion();
            }
        }
    });

    grid.addEventListener('click', function(event) {
        const cell = event.target.closest('.cell');
        if (!cell || cell.classList.contains('empty-cell')) return;
        if ((cell.id === 'd1' && cell.classList.contains('default-user-active')) || (cell.id === 'a1' && cell.classList.contains('default-user-active'))) return;

        // === LOGIQUE DE GESTION DE LA CASE C2 ===
        if (cell.id === 'c2') {
            const choiceButton = event.target.closest('.choice-button');
            const listAddButton = event.target.closest('.list-add-button');
            const locationItem = event.target.closest('.location-item');

            if (choiceButton) {
                const value = choiceButton.getAttribute('data-value');
                if (value === 'R') {
                    handleRChoice(cell);
                } else {
                    handleXRChoice(cell, value);
                }
            } else if (listAddButton) {
                handleListAdd(cell);
            } else if (locationItem) {
                handleLocationItemClick(locationItem);
            } else if (cell.querySelector('.cell-content')) {
                showC2Buttons();
            }
            return;
        }

        if (event.target.tagName === 'BUTTON') {
            const timeString = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const cellContent = cell.querySelector('.cell-content');
            if (cellContent) {
                cellContent.textContent = timeString;
                cellContent.classList.remove('placeholder');
            } else {
                cell.innerHTML = `<span class="cell-content">${timeString}</span>`;
            }
            cell.style.cursor = 'default';
            updateResults();
            checkCompletion();
            return;
        }

        const dropdownItem = event.target.closest('.dropdown-item');
        if (dropdownItem) {
            const cellId = cell.id;
            const contentSpan = cell.querySelector('.cell-content');

            if (cellId === 'a1') { 
                if (dropdownItem.classList.contains('add-item')) {
                    const name = prompt("Veuillez entrer une nouvelle locale :"); 
                    if (name && name.trim()) {
                         const i = createDropdownItem(name.trim()); 
                         initialLocales.push(name.trim()); 
                         updateA1MenuWithDefaults(); 
                         setDefaultLocale(name.trim());
                    } 
                    return; 
                } else {
                    setDefaultLocale(dropdownItem.textContent.replace(/^â˜… /, '').replace(/ \(par dÃ©faut\)$/, '')); 
                    updateResults(); 
                    checkCompletion(); 
                    if (activeMenu) { activeMenu.classList.remove('show'); activeMenu = null; }
                    return;
                }
            }

            if (cellId === 'd1' && dropdownItem.classList.contains('add-item')) { 
                const name = prompt("Veuillez entrer un nouveau prÃ©nom :"); 
                if (name && name.trim()) { 
                    const i = createDropdownItem(name.trim()); 
                    initialUsers.push(name.trim());
                    updateD1MenuWithDefault(); 
                    setDefaultUser(name.trim());
                } 
                return; 
            }
            if (cellId === 'd1' && !dropdownItem.classList.contains('add-item')) { 
                setDefaultUser(dropdownItem.textContent.replace(/^â˜… /, '').replace(/ \(par dÃ©faut\)$/, '')); 
                updateResults(); 
                checkCompletion(); 
                if (activeMenu) { activeMenu.classList.remove('show'); activeMenu = null; }
                return; 
            }
            if (cellId === 'c3') { 
                const item = dropdownItem; 
                const span = cell.querySelector('.cell-content'); 
                let state = (parseInt(item.dataset.colorState || '0') + 1) % 3; 
                item.dataset.colorState = state; 
                item.classList.remove('text-green', 'text-red'); 
                cell.classList.remove('text-green', 'text-red'); 
                if (state === 1) { 
                    item.classList.add('text-green'); 
                    cell.classList.add('text-green'); 
                } else if (state === 2) { 
                    item.classList.add('text-red'); 
                    cell.classList.add('text-red'); 
                }
                span.textContent = item.textContent.trim();
                span.classList.remove('placeholder');
                if (activeMenu) { activeMenu.classList.remove('show'); activeMenu = null; }
                updateResults();
                checkCompletion();
                return;
            }
            contentSpan.textContent = dropdownItem.textContent.trim();
            contentSpan.classList.remove('placeholder');
            if (activeMenu) { activeMenu.classList.remove('show'); activeMenu = null; }
            updateResults();
            checkCompletion();
        } else {
            const dropdown = cell.querySelector('.dropdown-menu');
            if (dropdown) {
                if (activeMenu && activeMenu !== dropdown) {
                    activeMenu.classList.remove('show');
                }
                dropdown.classList.toggle('show');
                activeMenu = dropdown.classList.contains('show') ? dropdown : null;
            }
        }
    });

    document.getElementById('refresh-button').addEventListener('click', manualRefresh);
    });
</script>
</body>
</html>
